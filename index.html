<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidado SAIEP - La An√≥nima</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); padding: 30px; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 10px; font-size: 2.2em; }
        .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 30px; font-size: 1.1em; }
        .upload-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 10px; margin-bottom: 30px; color: white; }
        .upload-section h2 { margin-bottom: 15px; font-size: 1.5em; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-input-wrapper input[type=file] { position: absolute; left: -9999px; }
        .file-input-label { display: block; padding: 20px; background: white; color: #667eea; text-align: center; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.1em; transition: all 0.3s; border: 3px dashed #667eea; }
        .file-input-label:hover { background: #f8f9fa; transform: scale(1.02); }
        .files-loaded { margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 8px; }
        .btn { padding: 12px 30px; border: none; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.3s; margin: 5px; }
        .btn-primary { background: #27ae60; color: white; }
        .btn-primary:hover { background: #229954; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3); }
        .btn-secondary { background: #3498db; color: white; }
        .btn-secondary:hover { background: #2980b9; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-warning:hover { background: #f57c00; }
        .actions { text-align: center; margin: 20px 0; }
        .table-container { overflow-x: auto; margin-top: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 10; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #ecf0f1; font-size: 0.9em; }
        tr:hover { background: #f8f9fa; }
        .cumplimiento-excelente { background: #d4edda; color: #155724; font-weight: bold; }
        .cumplimiento-bueno { background: #fff3cd; color: #856404; font-weight: bold; }
        .cumplimiento-regular { background: #f8d7da; color: #721c24; font-weight: bold; }
        .cumplimiento-vacio { background: #e9ecef; color: #6c757d; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .stat-value { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .stat-label { font-size: 0.9em; opacity: 0.9; }
        .loading { text-align: center; padding: 20px; color: #7f8c8d; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 60px 20px; color: #95a5a6; }
        .month-selector { margin: 20px 0; text-align: center; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .month-selector input, .month-selector select { padding: 12px 24px; border: 2px solid #667eea; border-radius: 8px; font-size: 1.1em; margin: 0 10px; cursor: pointer; transition: all 0.3s; font-weight: bold; color: #2c3e50; background: white; }
        .month-selector label { font-weight: bold; color: #2c3e50; font-size: 1.1em; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä CONSOLIDADO DE CUMPLIMIENTOS</h1>
        <div class="subtitle">Sistema de An√°lisis de Proveedores - SAIEP ¬∑ La An√≥nima</div>

        <div class="upload-section">
            <h2>üìÅ Cargar PDFs de Recepciones</h2>
            <p style="margin-bottom: 15px; opacity: 0.9;">Seleccione todos los PDFs generados por el sistema de control de √≥rdenes</p>
            
            <div class="file-input-wrapper">
                <input type="file" id="pdfInput" accept=".pdf" multiple>
                <label for="pdfInput" class="file-input-label">
                    üîç Seleccionar PDFs (puede elegir m√∫ltiples archivos)
                </label>
            </div>

            <div id="filesLoaded" class="files-loaded" style="display: none;">
                <strong>Archivos cargados:</strong>
                <div id="filesList"></div>
            </div>
        </div>

        <div class="month-selector">
            <label>üìÖ Per√≠odo:</label>
            <input type="month" id="monthInput" value="">
            <p style="margin-top: 8px; font-size: 0.9em; color: #7f8c8d;">
                Seleccione el mes y a√±o del reporte
            </p>
        </div>

        <div class="month-selector" style="margin-top: 20px;">
            <label>üó∫Ô∏è Zona:</label>
            <select id="zoneSelector" style="min-width: 300px;">
                <option value="NEUQUEN CIUDAD" selected>Neuqu√©n Ciudad (15 sucursales)</option>
                <option value="NEUQUEN INTERIOR">Neuqu√©n Interior (14 sucursales)</option>
                <option value="RIO NEGRO">R√≠o Negro (17 sucursales)</option>
                <option value="TRELEW">Trelew (11 sucursales)</option>
                <option value="VIEDMA">Viedma (9 sucursales)</option>
            </select>
            <p style="margin-top: 8px; font-size: 0.9em; color: #7f8c8d;">
                Filtra las sucursales por zona geogr√°fica
            </p>
        </div>

        <div class="actions">
            <button class="btn btn-primary" onclick="procesarPDFs()">üöÄ Procesar y Actualizar Tabla</button>
            <button class="btn btn-secondary" onclick="exportarExcel()" id="btnExcel" style="display: none;">üìä Exportar Excel</button>
            <button class="btn btn-secondary" onclick="exportarPDF()" id="btnPDF" style="display: none;">üìÑ Exportar PDF</button>
            <button class="btn btn-warning" onclick="borrarDatosCargados()">üóëÔ∏è Borrar Datos Cargados</button>
            <button class="btn btn-danger" onclick="limpiarConClave()">üóëÔ∏è Limpiar Todo (Admin)</button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Procesando PDFs...</p>
        </div>

        <div id="statsContainer" style="display: none;">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Sucursales</div>
                    <div class="stat-value" id="statSucursales">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Proveedores</div>
                    <div class="stat-value" id="statProveedores">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Cumplimiento Global</div>
                    <div class="stat-value" id="statPromedio">0%</div>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h3 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">
                    üìä Cumplimiento por Proveedor
                </h3>
                <div id="proveedoresCards" style="
                    display: grid; 
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
                    gap: 15px;
                    margin-bottom: 30px;
                "></div>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="font-size: 1.1em; font-weight: bold; color: #2c3e50; margin-bottom: 15px; text-align: center;">
                    Gr√°fico de Cumplimiento
                </div>
                <canvas id="cumplimientoChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <div id="tableContainer" class="table-container" style="display: none;">
            <table id="tablaConsolidado">
                <thead>
                    <tr>
                        <th>Sucursal</th>
                        <th>CCU</th>
                        <th>QUILMES</th>
                        <th>COCA COLA</th>
                        <th>DANONE</th>
                        <th>MASTELLONE</th>
                    </tr>
                </thead>
                <tbody id="tablaBody">
                </tbody>
            </table>
        </div>

        <div id="emptyState" class="empty-state">
            <div style="font-size: 4em;">üìã</div>
            <h3>No hay datos cargados</h3>
            <p>Seleccione los PDFs de recepciones para generar el consolidado</p>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let datosConsolidados = {};
        let archivosSeleccionados = [];

        const SUCURSALES_SISTEMA = [
            '006','068','162','225','226','229','232','233','235','236','237','239','240','248','254',
            '050','076','172','182','188','213','228','230','234','247','259','266','356','357',
            '007','010','042','048','051','053','092','164','195','238','241','242','243','246','265','363','063',
            '012','013','014','016','044','045','134','167','181','207','064',
            '011','046','047','069','163','208','215','216','079'
        ];
        
        const PROVEEDORES = ['CCU', 'QUILMES', 'COCA COLA', 'DANONE', 'MASTELLONE'];
        
        const ZONAS = {
            'NEUQUEN CIUDAD': ['006','068','162','225','226','229','232','233','235','236','237','239','240','248','254'],
            'NEUQUEN INTERIOR': ['050','076','172','182','188','213','228','230','234','247','259','266','356','357'],
            'RIO NEGRO': ['007','010','042','048','051','053','092','164','195','238','241','242','243','246','265','363','063'],
            'TRELEW': ['012','013','014','016','044','045','134','167','181','207','064'],
            'VIEDMA': ['011','046','047','069','163','208','215','216','079']
        };

        const SUCURSALES_RA = {
            'QUILMES': ['229','233','235','236','237','248'],
            'COCA COLA': ['225','229','232','233','235','236','237','239','248']
        };

        const SUCURSALES_NO_DISPONIBLE = {
            '254': ['CCU','DANONE','MASTELLONE']
        };

        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbwnHKu6_5868rhYX2k5zTRg8LyqVgI2ADPeF1RVyB5pz9iJN9ATZg5z7wPdYy3BG7tgmg/exec';

        let zonaSeleccionada = 'NEUQUEN CIUDAD';
        let chart = null;

        document.addEventListener('DOMContentLoaded', async function() {
            document.getElementById('monthInput').value = '2026-01';
            await cargarDatosGoogleSheets();
            generarTabla();
        });

        document.getElementById('pdfInput').addEventListener('change', function(e) {
            Array.from(e.target.files).forEach(archivo => {
                if (!archivosSeleccionados.some(a => a.name === archivo.name)) {
                    archivosSeleccionados.push(archivo);
                }
            });
            actualizarListaArchivos();
            e.target.value = '';
        });

        document.getElementById('monthInput').addEventListener('change', async function() {
            await cargarDatosGoogleSheets();
            generarTabla();
        });

        document.getElementById('zoneSelector').addEventListener('change', function() {
            zonaSeleccionada = this.value;
            generarTabla();
        });

        function actualizarListaArchivos() {
            if (archivosSeleccionados.length > 0) {
                document.getElementById('filesLoaded').style.display = 'block';
                let html = '<table style="width:100%; color:#2c3e50;"><tr style="background:#667eea; color:white;"><th>Archivo</th><th>Acci√≥n</th></tr>';
                archivosSeleccionados.forEach((a, i) => {
                    html += `<tr><td>${a.name}</td><td><button onclick="eliminarArchivo(${i})" style="background:#e74c3c; color:white; border:none; padding:4px 12px; border-radius:4px; cursor:pointer;">üóëÔ∏è</button></td></tr>`;
                });
                html += '</table>';
                document.getElementById('filesList').innerHTML = html;
            } else {
                document.getElementById('filesLoaded').style.display = 'none';
            }
        }

        function eliminarArchivo(index) {
            archivosSeleccionados.splice(index, 1);
            actualizarListaArchivos();
        }

        async function procesarPDFs() {
            if (archivosSeleccionados.length === 0) {
                alert('‚ö†Ô∏è Seleccione al menos un PDF');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';

            for (const archivo of archivosSeleccionados) {
                await procesarUnPDF(archivo);
            }

            generarTabla();
            await guardarEnGoogleSheets();
            
            archivosSeleccionados = [];
            actualizarListaArchivos();
            document.getElementById('loading').style.display = 'none';
        }

        async function procesarUnPDF(archivo) {
            try {
                const arrayBuffer = await archivo.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                let textoCompleto = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    textoCompleto += textContent.items.map(item => item.str).join(' ') + ' ';
                }

                extraerDatos(textoCompleto, archivo.name);
            } catch (error) {
                console.error(`Error procesando ${archivo.name}:`, error);
            }
        }

        function extraerDatos(texto, nombreArchivo) {
            let proveedor = '';
            const matchProveedor = texto.match(/Proveedor:\s*([A-Z\s]+?)(?:\s+Sucursal|Fecha|$)/i);
            if (matchProveedor) {
                proveedor = matchProveedor[1].trim();
                if (proveedor.includes('COCA')) proveedor = 'COCA COLA';
                else if (proveedor.includes('QUILMES')) proveedor = 'QUILMES';
                else if (proveedor.includes('DANONE')) proveedor = 'DANONE';
                else if (proveedor.includes('MASTELLONE')) proveedor = 'MASTELLONE';
                else if (proveedor.includes('CCU')) proveedor = 'CCU';
            }

            let sucursal = '';
            const matchSucursal = texto.match(/Sucursal:\s*(\d+)/i);
            if (matchSucursal) {
                sucursal = matchSucursal[1].trim().padStart(3, '0');
            }

            const matchTotales = texto.match(/TOTA\s*LES?\s+(\d+)\s+(\d+)/i);
            
            if (matchTotales) {
                const pedido = parseInt(matchTotales[1]);
                const recibido = parseInt(matchTotales[2]);

                if (proveedor && sucursal && SUCURSALES_SISTEMA.includes(sucursal)) {
                    if (!datosConsolidados[sucursal]) {
                        datosConsolidados[sucursal] = {};
                    }
                    
                    if (datosConsolidados[sucursal][proveedor] === undefined) {
                        datosConsolidados[sucursal][proveedor] = {
                            pedidoTotal: pedido,
                            recibidoTotal: recibido
                        };
                    } else {
                        datosConsolidados[sucursal][proveedor].pedidoTotal += pedido;
                        datosConsolidados[sucursal][proveedor].recibidoTotal += recibido;
                    }
                }
            }
        }

        async function cargarDatosGoogleSheets() {
            try {
                const mes = document.getElementById('monthInput').value;
                console.log('üìÖ Cargando datos para el mes:', mes);
                console.log('üîó URL:', `${GOOGLE_SHEETS_URL}?mes=${mes}`);
                
                const response = await fetch(`${GOOGLE_SHEETS_URL}?mes=${mes}`);
                console.log('üì° Response status:', response.status);
                
                const responseText = await response.text();
                console.log('üìÑ Response text:', responseText);
                
                const datos = JSON.parse(responseText);
                console.log('üìä Datos recibidos:', datos);
                console.log('üìä Total de registros:', Array.isArray(datos) ? datos.length : 'No es array');
                
                if (datos.error) {
                    console.error('‚ùå Error del servidor:', datos.error);
                    alert('‚ö†Ô∏è Error al cargar datos: ' + datos.error);
                }
                
                datosConsolidados = {};
                SUCURSALES_SISTEMA.forEach(suc => {
                    datosConsolidados[suc] = {};
                });
                
                if (Array.isArray(datos)) {
                    datos.forEach(fila => {
                        const sucursal = String(fila.Sucursal).padStart(3, '0');
                        const proveedor = fila.Proveedor;
                        const cumplimiento = fila.Cumplimiento;
                        
                        console.log(`Procesando: Suc ${sucursal}, Prov ${proveedor}, Cumpl ${cumplimiento}`);
                        
                        if (cumplimiento !== 'RA' && cumplimiento !== 'N/R' && typeof cumplimiento === 'number') {
                            const pedidoBase = 100;
                            const recibidoCalculado = Math.round(pedidoBase * cumplimiento / 100);
                            
                            datosConsolidados[sucursal][proveedor] = {
                                pedidoTotal: pedidoBase,
                                recibidoTotal: recibidoCalculado
                            };
                        }
                    });
                }
                
                console.log('‚úÖ Datos consolidados:', datosConsolidados);
                
                return true;
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                alert('‚ö†Ô∏è Error de conexi√≥n: ' + error.message);
                SUCURSALES_SISTEMA.forEach(suc => {
                    if (!datosConsolidados[suc]) {
                        datosConsolidados[suc] = {};
                    }
                });
                return false;
            }
        }

        async function guardarEnGoogleSheets() {
            try {
                const mesSeleccionado = document.getElementById('monthInput').value;
                const datosParaGuardar = [];
                
                Object.keys(datosConsolidados).forEach(sucursal => {
                    Object.keys(datosConsolidados[sucursal]).forEach(proveedor => {
                        const datos = datosConsolidados[sucursal][proveedor];
                        
                        let cumplimiento;
                        if (typeof datos === 'object' && datos.pedidoTotal !== undefined) {
                            cumplimiento = datos.pedidoTotal > 0 ? 
                                Math.round((datos.recibidoTotal / datos.pedidoTotal) * 100) : 0;
                        } else {
                            cumplimiento = datos;
                        }
                        
                        datosParaGuardar.push({
                            Sucursal: sucursal,
                            Proveedor: proveedor,
                            Cumplimiento: cumplimiento,
                            Mes: mesSeleccionado,
                            Usuario: 'Sistema'
                        });
                    });
                });
                
                const formData = new URLSearchParams();
                formData.append('action', 'save');
                formData.append('data', JSON.stringify(datosParaGuardar));
                
                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                return result.success;
            } catch (error) {
                console.error('Error guardando:', error);
                return false;
            }
        }

        function generarTabla() {
            const tbody = document.getElementById('tablaBody');
            tbody.innerHTML = '';

            const sucursalesZona = ZONAS[zonaSeleccionada] || SUCURSALES_SISTEMA;
            const sucursalesOrdenadas = sucursalesZona.filter(s => SUCURSALES_SISTEMA.includes(s));

            let totalCumplimientos = 0;
            let cantidadCeldas = 0;

            sucursalesOrdenadas.forEach(sucursal => {
                const tr = document.createElement('tr');
                
                const tdSucursal = document.createElement('td');
                tdSucursal.style.fontWeight = 'bold';
                tdSucursal.style.color = '#2c3e50';
                tdSucursal.style.textAlign = 'center';
                tdSucursal.textContent = sucursal;
                tr.appendChild(tdSucursal);

                PROVEEDORES.forEach(proveedor => {
                    const td = document.createElement('td');
                    
                    const esND = SUCURSALES_NO_DISPONIBLE[sucursal]?.includes(proveedor);
                    const esRA = SUCURSALES_RA[proveedor]?.includes(sucursal);
                    
                    if (esND) {
                        td.textContent = 'N/R';
                        td.style.background = '#f5f5f5';
                        td.style.color = '#9e9e9e';
                    } else if (esRA) {
                        td.textContent = 'RA';
                        td.style.background = '#e3f2fd';
                        td.style.color = '#1565c0';
                    } else {
                        const datos = datosConsolidados[sucursal]?.[proveedor];
                        const cumplimiento = datos ? 
                            Math.round((datos.recibidoTotal / datos.pedidoTotal) * 100) : 
                            undefined;
                        
                        if (cumplimiento !== undefined) {
                            td.textContent = cumplimiento + '%';
                            
                            if (cumplimiento >= 90) td.className = 'cumplimiento-excelente';
                            else if (cumplimiento >= 75) td.className = 'cumplimiento-bueno';
                            else td.className = 'cumplimiento-regular';

                            totalCumplimientos += cumplimiento;
                            cantidadCeldas++;
                        } else {
                            td.textContent = '-';
                            td.className = 'cumplimiento-vacio';
                        }
                    }
                    
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });

            document.getElementById('statSucursales').textContent = `${sucursalesOrdenadas.length} (${zonaSeleccionada})`;
            
            const proveedoresConDatos = new Set();
            SUCURSALES_SISTEMA.forEach(suc => {
                if (datosConsolidados[suc]) {
                    Object.keys(datosConsolidados[suc]).forEach(prov => proveedoresConDatos.add(prov));
                }
            });
            document.getElementById('statProveedores').textContent = proveedoresConDatos.size;
            
            const promedioGeneral = cantidadCeldas > 0 ? Math.round(totalCumplimientos / cantidadCeldas) : 0;
            document.getElementById('statPromedio').textContent = promedioGeneral + '%';
            
            const promediosPorProveedor = {};
            PROVEEDORES.forEach(p => {
                let totalCumplimiento = 0;
                let contadorSucursales = 0;
                
                sucursalesOrdenadas.forEach(s => {
                    const datos = datosConsolidados[s]?.[p];
                    
                    if (datos !== undefined) {
                        let cumplimiento;
                        if (typeof datos === 'object' && datos.pedidoTotal !== undefined) {
                            cumplimiento = datos.pedidoTotal > 0 ? 
                                Math.round((datos.recibidoTotal / datos.pedidoTotal) * 100) : 0;
                        } else {
                            cumplimiento = datos;
                        }
                        
                        totalCumplimiento += cumplimiento;
                        contadorSucursales++;
                    }
                });
                
                promediosPorProveedor[p] = contadorSucursales > 0 ? 
                    Math.round(totalCumplimiento / contadorSucursales) : 0;
            });
            
            actualizarTarjetasProveedores(promediosPorProveedor);
            actualizarGrafico(promediosPorProveedor);
            
            document.getElementById('tableContainer').style.display = 'block';
            document.getElementById('statsContainer').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            
            if (cantidadCeldas > 0) {
                document.getElementById('btnExcel').style.display = 'inline-block';
                document.getElementById('btnPDF').style.display = 'inline-block';
            }
        }

        function actualizarTarjetasProveedores(promedios) {
            const container = document.getElementById('proveedoresCards');
            if (!container) return;
            
            container.innerHTML = '';
            
            PROVEEDORES.forEach(proveedor => {
                const cumplimiento = promedios[proveedor] || 0;
                
                let colorFondo, colorTexto;
                if (cumplimiento >= 90) {
                    colorFondo = '#d4edda';
                    colorTexto = '#155724';
                } else if (cumplimiento >= 75) {
                    colorFondo = '#fff3cd';
                    colorTexto = '#856404';
                } else if (cumplimiento > 0) {
                    colorFondo = '#f8d7da';
                    colorTexto = '#721c24';
                } else {
                    colorFondo = '#e9ecef';
                    colorTexto = '#6c757d';
                }
                
                const card = document.createElement('div');
                card.style.cssText = `
                    background: ${colorFondo};
                    color: ${colorTexto};
                    padding: 20px;
                    border-radius: 12px;
                    text-align: center;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    transition: all 0.3s ease;
                    cursor: pointer;
                    border: 2px solid ${colorTexto}20;
                `;
                
                card.innerHTML = `
                    <div style="font-size: 0.9em; font-weight: 600; margin-bottom: 8px; opacity: 0.8;">
                        ${proveedor}
                    </div>
                    <div style="font-size: 2.5em; font-weight: bold;">
                        ${cumplimiento}%
                    </div>
                `;
                
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px)';
                    this.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                });
                
                container.appendChild(card);
            });
        }

        function actualizarGrafico(promedios) {
            const ctx = document.getElementById('cumplimientoChart').getContext('2d');
            
            const valores = PROVEEDORES.map(p => promedios[p] || 0);
            
            const coloresFondo = valores.map(v => {
                if (v >= 90) return 'rgba(129, 199, 132, 0.8)';
                if (v >= 75) return 'rgba(255, 213, 79, 0.8)';
                if (v > 0) return 'rgba(229, 115, 115, 0.8)';
                return 'rgba(189, 189, 189, 0.8)';
            });
            
            if (chart) chart.destroy();
            
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: PROVEEDORES,
                    datasets: [{
                        label: 'Cumplimiento (%)',
                        data: valores,
                        backgroundColor: coloresFondo,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { 
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        async function exportarExcel() {
            const mesSeleccionado = document.getElementById('monthInput').value;
            const [a√±o, mes] = mesSeleccionado.split('-');

            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Cumplimientos');

            worksheet.columns = [
                { width: 12 }, { width: 12 }, { width: 12 }, { width: 14 }, { width: 12 }, { width: 14 }
            ];

            worksheet.mergeCells('A1:F1');
            const titulo = worksheet.getCell('A1');
            titulo.value = 'CONSOLIDADO DE CUMPLIMIENTOS';
            titulo.font = { bold: true, size: 14 };
            titulo.alignment = { horizontal: 'center' };
            titulo.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF8F9FA' } };

            const headers = ['Sucursal', 'CCU', 'QUILMES', 'COCA COLA', 'DANONE', 'MASTELLONE'];
            const headerRow = worksheet.getRow(3);
            headers.forEach((titulo, index) => {
                const cell = headerRow.getCell(index + 1);
                cell.value = titulo;
                cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667EEA' } };
                cell.alignment = { horizontal: 'center' };
            });

            const sucursalesZona = ZONAS[zonaSeleccionada] || SUCURSALES_SISTEMA;
            const sucursalesOrdenadas = sucursalesZona.filter(s => SUCURSALES_SISTEMA.includes(s));

            sucursalesOrdenadas.forEach((sucursal, index) => {
                const fila = worksheet.getRow(4 + index);
                fila.getCell(1).value = sucursal;
                fila.getCell(1).font = { bold: true };
                fila.getCell(1).alignment = { horizontal: 'center' };

                PROVEEDORES.forEach((proveedor, colIndex) => {
                    const cell = fila.getCell(2 + colIndex);
                    
                    const esND = SUCURSALES_NO_DISPONIBLE[sucursal]?.includes(proveedor);
                    const esRA = SUCURSALES_RA[proveedor]?.includes(sucursal);
                    
                    if (esND) {
                        cell.value = 'N/R';
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF5F5F5' } };
                    } else if (esRA) {
                        cell.value = 'RA';
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE3F2FD' } };
                    } else {
                        const datos = datosConsolidados[sucursal]?.[proveedor];
                        const cumplimiento = datos ? 
                            Math.round((datos.recibidoTotal / datos.pedidoTotal) * 100) : 
                            undefined;

                        if (cumplimiento !== undefined) {
                            cell.value = cumplimiento / 100;
                            cell.numFmt = '0%';
                            cell.font = { bold: true };
                            
                            if (cumplimiento >= 90) {
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD4EDDA' } };
                                cell.font.color = { argb: 'FF155724' };
                            } else if (cumplimiento >= 75) {
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF3CD' } };
                                cell.font.color = { argb: 'FF856404' };
                            } else {
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF8D7DA' } };
                                cell.font.color = { argb: 'FF721C24' };
                            }
                        } else {
                            cell.value = '-';
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE9ECEF' } };
                        }
                    }
                    cell.alignment = { horizontal: 'center' };
                });
            });

            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            saveAs(blob, `Consolidado_${a√±o}_${mes}_${zonaSeleccionada}.xlsx`);
        }

        async function exportarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4');
    
    const mesSeleccionado = document.getElementById('monthInput').value;
    const [a√±o, mes] = mesSeleccionado.split('-');
    const nombresMeses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    const nombreMes = nombresMeses[parseInt(mes) - 1];
    
    // T√≠tulo
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text('CONSOLIDADO DE CUMPLIMIENTOS', 148, 12, { align: 'center' });
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text('Per√≠odo: ' + nombreMes + ' ' + a√±o + ' | Zona: ' + zonaSeleccionada, 148, 18, { align: 'center' });
    
    // Calcular promedios por proveedor
    const sucursalesZona = ZONAS[zonaSeleccionada] || SUCURSALES_SISTEMA;
    const sucursalesOrdenadas = sucursalesZona.filter(s => SUCURSALES_SISTEMA.includes(s));
    
    const promediosPorProveedor = {};
    PROVEEDORES.forEach(p => {
        let totalCumplimiento = 0;
        let contadorSucursales = 0;
        
        sucursalesOrdenadas.forEach(s => {
            const datos = datosConsolidados[s] && datosConsolidados[s][p];
            
            if (datos !== undefined) {
                let cumplimiento;
                if (typeof datos === 'object' && datos.pedidoTotal !== undefined) {
                    cumplimiento = datos.pedidoTotal > 0 ? Math.round((datos.recibidoTotal / datos.pedidoTotal) * 100) : 0;
                } else {
                    cumplimiento = datos;
                }
                
                totalCumplimiento += cumplimiento;
                contadorSucursales++;
            }
        });
        
        promediosPorProveedor[p] = contadorSucursales > 0 ? Math.round(totalCumplimiento / contadorSucursales) : 0;
    });
    
    // Dibujar cuadrados en la parte superior (VERTICAL) - Estilo Web
const boxWidth = 44;
const boxHeight = 26;
const boxSpacing = 6;
const startX = 12;
const boxY = 24;

PROVEEDORES.forEach((proveedor, index) => {
    const cumplimiento = promediosPorProveedor[proveedor];
    const x = startX + (index * (boxWidth + boxSpacing));
    
    let fillColor, textColor;
    if (cumplimiento >= 90) {
        fillColor = [212, 237, 218];
        textColor = [21, 87, 36];
    } else if (cumplimiento >= 75) {
        fillColor = [255, 243, 205];
        textColor = [133, 100, 4];
    } else if (cumplimiento > 0) {
        fillColor = [248, 215, 218];
        textColor = [114, 28, 36];
    } else {
        fillColor = [233, 236, 239];
        textColor = [108, 117, 125];
    }
    
    // Dibujar cuadrado redondeado
    doc.setFillColor(fillColor[0], fillColor[1], fillColor[2]);
    doc.roundedRect(x, boxY, boxWidth, boxHeight, 5, 5, 'F');
    
    // Nombre del proveedor (ARRIBA, dentro del cuadrado)
    doc.setFontSize(7);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
    doc.text(proveedor, x + boxWidth/2, boxY + 6, { align: 'center' });
    
    // Porcentaje (ABAJO, grande y bold)
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
    doc.text(cumplimiento + '%', x + boxWidth/2, boxY + 18, { align: 'center' });
});
    
    // Preparar datos para la tabla
    const headers = [['Sucursal', 'CCU', 'QUILMES', 'COCA COLA', 'DANONE', 'MASTELLONE']];
    const rows = [];
    
    sucursalesOrdenadas.forEach(sucursal => {
        const fila = [sucursal];
        
        PROVEEDORES.forEach(proveedor => {
            const esND = SUCURSALES_NO_DISPONIBLE[sucursal] && SUCURSALES_NO_DISPONIBLE[sucursal].includes(proveedor);
            const esRA = SUCURSALES_RA[proveedor] && SUCURSALES_RA[proveedor].includes(sucursal);
            
            if (esND) {
                fila.push('N/R');
            } else if (esRA) {
                fila.push('RA');
            } else {
                const datos = datosConsolidados[sucursal] && datosConsolidados[sucursal][proveedor];
                const cumplimiento = datos ? Math.round((datos.recibidoTotal / datos.pedidoTotal) * 100) : undefined;
                fila.push(cumplimiento !== undefined ? cumplimiento + '%' : '-');
            }
        });
        
        rows.push(fila);
    });
    
    // Generar tabla (empieza m√°s abajo para dar espacio a los cuadrados)
    doc.autoTable({
        head: headers,
        body: rows,
        startY: 60,
        theme: 'grid',
        headStyles: {
            fillColor: [102, 126, 234],
            textColor: 255,
            fontStyle: 'bold',
            halign: 'center'
        },
        bodyStyles: {
            halign: 'center',
            fontSize: 9
        },
        columnStyles: {
            0: { fontStyle: 'bold', halign: 'center' }
        },
        didParseCell: function(data) {
            if (data.section === 'body' && data.column.index > 0) {
                const valor = data.cell.raw;
                
                if (valor === 'N/R') {
                    data.cell.styles.fillColor = [245, 245, 245];
                    data.cell.styles.textColor = [158, 158, 158];
                } else if (valor === 'RA') {
                    data.cell.styles.fillColor = [227, 242, 253];
                    data.cell.styles.textColor = [21, 101, 192];
                } else if (valor !== '-') {
                    const num = parseInt(valor);
                    if (num >= 90) {
                        data.cell.styles.fillColor = [212, 237, 218];
                        data.cell.styles.textColor = [21, 87, 36];
                        data.cell.styles.fontStyle = 'bold';
                    } else if (num >= 75) {
                        data.cell.styles.fillColor = [255, 243, 205];
                        data.cell.styles.textColor = [133, 100, 4];
                        data.cell.styles.fontStyle = 'bold';
                    } else {
                        data.cell.styles.fillColor = [248, 215, 218];
                        data.cell.styles.textColor = [114, 28, 36];
                        data.cell.styles.fontStyle = 'bold';
                    }
                } else {
                    data.cell.styles.fillColor = [233, 236, 239];
                    data.cell.styles.textColor = [108, 117, 125];
                }
            }
        }
    });
    
    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(128);
        doc.text('P√°gina ' + i + ' de ' + pageCount, 148, 200, { align: 'center' });
        doc.text('Generado: ' + new Date().toLocaleString('es-AR'), 148, 205, { align: 'center' });
    }
    
    doc.save('Consolidado_' + a√±o + '_' + mes + '_' + zonaSeleccionada + '.pdf');
}

        async function borrarDatosCargados() {
            const mesSeleccionado = document.getElementById('monthInput').value;
            
            const sucursalesConDatos = Object.keys(datosConsolidados).filter(suc => 
                Object.keys(datosConsolidados[suc]).length > 0
            ).sort();
            
            if (sucursalesConDatos.length === 0) {
                alert('‚ö†Ô∏è No hay datos para borrar');
                return;
            }
            
            const modalHTML = `
                <div id="modalBorrar" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.7); display: flex; align-items: center;
                    justify-content: center; z-index: 9999;">
                    <div style="background: white; padding: 30px; border-radius: 15px;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 500px; width: 90%;">
                        <h2 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">üóëÔ∏è Borrar Datos</h2>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: bold; color: #2c3e50; display: block; margin-bottom: 5px;">Sucursal:</label>
                            <select id="selectSucursal" style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 5px; font-size: 1em;">
                                <option value="">-- Seleccione Sucursal --</option>
                                ${sucursalesConDatos.map(s => `<option value="${s}">${s}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="font-weight: bold; color: #2c3e50; display: block; margin-bottom: 5px;">Proveedor:</label>
                            <select id="selectProveedor" style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 5px; font-size: 1em;" disabled>
                                <option value="">-- Primero seleccione sucursal --</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="ejecutarBorrado()" id="btnConfirmarBorrado" 
                                style="padding: 12px 30px; background: #e74c3c; color: white; border: none;
                                border-radius: 8px; font-weight: bold; cursor: pointer; opacity: 0.5;" disabled>
                                üóëÔ∏è Borrar
                            </button>
                            <button onclick="cerrarModalBorrar()" 
                                style="padding: 12px 30px; background: #95a5a6; color: white; border: none;
                                border-radius: 8px; font-weight: bold; cursor: pointer;">
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            document.getElementById('selectSucursal').addEventListener('change', function() {
                const sucursal = this.value;
                const selectProveedor = document.getElementById('selectProveedor');
                
                if (sucursal) {
                    const proveedoresConDatos = Object.keys(datosConsolidados[sucursal]);
                    selectProveedor.disabled = false;
                    selectProveedor.innerHTML = '<option value="">-- Seleccione Proveedor --</option>' +
                        proveedoresConDatos.map(p => `<option value="${p}">${p}</option>`).join('');
                } else {
                    selectProveedor.disabled = true;
                    selectProveedor.innerHTML = '<option value="">-- Primero seleccione sucursal --</option>';
                    document.getElementById('btnConfirmarBorrado').disabled = true;
                    document.getElementById('btnConfirmarBorrado').style.opacity = '0.5';
                }
            });
            
            document.getElementById('selectProveedor').addEventListener('change', function() {
                const btnConfirmar = document.getElementById('btnConfirmarBorrado');
                if (this.value) {
                    btnConfirmar.disabled = false;
                    btnConfirmar.style.opacity = '1';
                } else {
                    btnConfirmar.disabled = true;
                    btnConfirmar.style.opacity = '0.5';
                }
            });
        }

        function cerrarModalBorrar() {
            const modal = document.getElementById('modalBorrar');
            if (modal) modal.remove();
        }

        async function ejecutarBorrado() {
            const sucursal = document.getElementById('selectSucursal').value;
            const proveedor = document.getElementById('selectProveedor').value;
            const mesSeleccionado = document.getElementById('monthInput').value;
            
            if (!sucursal || !proveedor) {
                alert('‚ö†Ô∏è Seleccione sucursal y proveedor');
                return;
            }
            
            if (!confirm(`¬øBorrar datos de:\nSucursal: ${sucursal}\nProveedor: ${proveedor}\nMes: ${mesSeleccionado}?`)) {
                return;
            }
            
            if (datosConsolidados[sucursal] && datosConsolidados[sucursal][proveedor]) {
                delete datosConsolidados[sucursal][proveedor];
            }
            
            try {
                const formData = new URLSearchParams();
                formData.append('action', 'delete_specific');
                formData.append('mes', mesSeleccionado);
                formData.append('sucursal', sucursal);
                formData.append('proveedor', proveedor);
                
                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Datos borrados exitosamente:\nSucursal ${sucursal} - ${proveedor}`);
                    cerrarModalBorrar();
                    generarTabla();
                } else {
                    alert('‚ö†Ô∏è Error al borrar de Google Sheets');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error de conexi√≥n');
            }
        }

        async function limpiarConClave() {
            const clave = prompt('üîê Contrase√±a de administrador:');
            if (clave === 'admin2026') {
                const mesSeleccionado = document.getElementById('monthInput').value;
                if (confirm(`¬øLimpiar todos los datos del mes ${mesSeleccionado}?\n\n‚ö†Ô∏è ESTA ACCI√ìN NO SE PUEDE DESHACER`)) {
                    try {
                        // Limpiar datos locales
                        datosConsolidados = {};
                        SUCURSALES_SISTEMA.forEach(suc => {
                            datosConsolidados[suc] = {};
                        });
                        
                        // Limpiar en Google Sheets
                        const formData = new URLSearchParams();
                        formData.append('action', 'delete_month');
                        formData.append('mes', mesSeleccionado);
                        
                        const response = await fetch(GOOGLE_SHEETS_URL, {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            alert(`‚úÖ Todos los datos del mes ${mesSeleccionado} han sido eliminados exitosamente`);
                            generarTabla();
                        } else {
                            alert('‚ö†Ô∏è Datos locales limpiados, pero hubo un error al limpiar Google Sheets');
                            generarTabla();
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('‚ö†Ô∏è Datos locales limpiados, pero hubo un error de conexi√≥n con Google Sheets');
                        generarTabla();
                    }
                }
            } else if (clave !== null) {
                alert('‚ùå Contrase√±a incorrecta');
            }
        }
    </script>
</body>
</html>
